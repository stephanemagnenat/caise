<!DOCTYPE html>
<!-- inspired from https://websockets.readthedocs.io/en/stable/intro.html -->
<html>
	<head>
		<meta charset="UTF-8"> 
		<title>WebSocket demo</title>
	</head>
	<body>
		<form>
			Host: <input type="text" id="hostinput" value="localhost">
			Name: <input type="text" id="nameinput">
		</form>
		<div class="connect button">Connect</div>
		<canvas id="myCanvas" width="560" height="400"></canvas>
		<textarea id="logArea" rows="10" cols="80"></textarea>
		<script>
			var connect = document.querySelector('.connect'),
				hostinput = document.getElementById('hostinput'),
				nameinput = document.getElementById('nameinput'),
				canvas = document.getElementById("myCanvas"),
				ctx = canvas.getContext("2d"),
				logArea = document.getElementById('logArea'),
				players = {},
				websocket = null,
				lastRenderTimestamp = null
			;

			// setup renderer state
			ctx.strokeStyle = 'rgb(0,0,0)';
			ctx.fillStyle = 'rgb(220,220,220)';
			ctx.textAlign = "center";

			// render the canvas
			function render(timestamp) {
				// draw animation and update movements
				ctx.clearRect(0, 0, canvas.width, canvas.height);
				ctx.fillStyle = 'rgb(220,220,220)';
				ctx.fillRect(0, 0, 80, 400);
				ctx.beginPath();
                ctx.arc(280,200,200,0,2*Math.PI);
                ctx.fill();
                ctx.fillRect(80, 60, 400, 280);
				ctx.fillRect(480, 0, 80, 400);
				ctx.fillStyle = 'rgb(0,0,0)';
				for (const [name, data] of Object.entries(players)) {
                    var x = data.pos[0]*4 + 280
                    var y = data.pos[1]*4 + 200
					ctx.beginPath();
					ctx.arc(x, y, 8, 0, 2 * Math.PI);
					ctx.stroke();
					ctx.fillText(name, x, y+20);
					ctx.fillText(data.hits, x, y-14);
					if (lastRenderTimestamp) {
						// handle animations
						var deltaTime = (timestamp - lastRenderTimestamp) / 1000.;
						data.pos[0] += data.speed[0] * deltaTime;
						data.pos[1] += data.speed[1] * deltaTime;
						if (data.score_anim && data.score_anim > 0) {
							ctx.strokeStyle = 'rgb(255,0,0)';
							ctx.beginPath();
							ctx.arc(x, y, 16-data.score_anim*16, 0, 2 * Math.PI);
							ctx.stroke();
							ctx.strokeStyle = 'rgb(0,0,0)';
							data.score_anim -= deltaTime;
						}
					}
				}
				lastRenderTimestamp = timestamp;
				window.requestAnimationFrame(render);
			}

			connect.onclick = function (event) {
				websocket = new WebSocket("ws://" + hostinput.value + ":6789/");
				var name = nameinput.value;
				websocket.onopen = function (event) {
					websocket.send(name);
				};
				websocket.onmessage = function (event) {
					data = JSON.parse(event.data);
					switch (data.type) {
						case 'player_new':
							logArea.textContent += data.name + " connected\n";
							players[data.name] = { "pos": data.pos, "speed": data.speed, "hits": data.hits };
							break;
						case 'player_state':
							var player = players[data.name];
							// if hits were improved, set animation
							if (data.hits > player.hits) {
								players[data.name].score_anim = 1;
							}
							// update variables
							player.pos = data.pos;
							player.speed = data.speed;
							player.hits = data.hits;
							break;
						case 'player_part':
							logArea.textContent += data.name + " disconnected\n";
							delete players[data.name];
							break;
						default:
							console.error("unsupported event", data);
					}
				};
			};

			document.onkeydown = function (event) {
				if (event.key === "ArrowRight") {
					websocket.send(JSON.stringify({action: 'move', speed: [10,0]}));
				}
				else if (event.key === "ArrowLeft") {
					websocket.send(JSON.stringify({action: 'move', speed: [-10,0]}));
				}
				else if (event.key === "ArrowUp") {
					websocket.send(JSON.stringify({action: 'move', speed: [0,-10]}));
				}
				else if (event.key === "ArrowDown") {
					websocket.send(JSON.stringify({action: 'move', speed: [0,10]}));
				}
				else if (event.key === " ") {
					websocket.send(JSON.stringify({action: 'fire'}));
				}
			}

			window.requestAnimationFrame(render);

		</script>
	</body>
</html>
